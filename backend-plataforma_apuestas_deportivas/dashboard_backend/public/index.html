<!DOCTYPE html>
<html>
  <head>
    <title>Dashboard Apuestas</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <h2>Alertas en vivo</h2>
    <div id="alerts"></div>

    <h3>Enviar Cuotas</h3>
    <form id="oddsForm">
      <input type="text" name="match_id" placeholder="ID Partido" required />
      <input type="text" name="team" placeholder="Equipo" required />
      <input
        type="number"
        name="odds"
        placeholder="Cuota"
        step="0.01"
        required
      />
      <button type="submit">Enviar</button>
    </form>

    <h3>Partidos Activos</h3>
    <ul id="matchList"></ul>

    <script src="app.js"></script>
    <script>
      const form = document.getElementById("oddsForm");
      const matchList = document.getElementById("matchList");
      const alertsDiv = document.getElementById("alerts");

      try {
        const ws = new WebSocket("wss://localhost:3002")
        ws.onmessage = (msg) => {
          const data = JSON.parse(msg.data)

          const p = document.createElement("p");
          p.textContent = ` ${data.message}`;
          alertsDiv.prepend(p)
        };
      } catch (err) {
        console.log("WS no disponible aun")
      }

      async function cargarPartidos() {
        const resp = await fetch("/api/matches");
        const data = await resp.json();

        matchList.innerHTML = "";

        Object.values(data).forEach((m) => {
          const li = document.createElement("li");
          li.textContent = `ID ${m.match_id}: ${m.teamA || m.teams?.[0]} vs ${
            m.teamB || m.teams?.[1]
          } - Estado: ${m.status || "ABIERTA"}`;
          matchList.appendChild(li);
        });
      }

      setInterval(cargarPartidos, 5000);
      cargarPartidos();

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const match_id = form.match_id.value;
        const team = form.team.value;
        const odds = parseFloat(form.odds.value);

        await fetch("/api/set-odds", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ match_id, team, odds }),
        });

        form.reset();
      });
    </script>
  </body>
</html>
